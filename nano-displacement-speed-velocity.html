<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Displacement, Speed & Velocity – PromptSchola Physics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="Nano-lesson on displacement, distance, speed, and velocity in 1D motion."
  />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- MathJax -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['\\(','\\)'], ['$', '$']],
        displayMath: [['\\[','\\]'], ['$$','$$']]
      },
      svg: { fontCache: 'global' }
    };
  </script>
  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js">
  </script>

  <style>
    :root {
      --bg-body: #f3f4f6;
      --bg-card: #ffffff;
      --accent: #7e22ce;
      --accent-strong: #4c1d95;
      --text-main: #111827;
      --text-muted: #4b5563;
      --text-subtle: #9ca3af;
      --text-strong: #020617;
      --border-subtle: rgba(209, 213, 219, 0.7);
      --radius-card: 18px;
      --radius-pill: 999px;
      --shadow-card: 0 16px 35px rgba(15, 23, 42, 0.12);
      --font-main: 'Inter', system-ui, sans-serif;
      --transition-fast: 0.25s ease-out;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-main);
      background: radial-gradient(circle at top, #e5e7eb, #f9fafb 45%, #f3f4f6);
      color: var(--text-main);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    a { text-decoration: none; color: inherit; }

    .page { min-height: 100vh; display: flex; flex-direction: column; }

    .container {
      max-width: 1120px;
      margin: 0 auto;
      padding: 0 1.3rem;
    }

    /* NAV */
    header {
      position: sticky; top: 0; z-index: 40;
      backdrop-filter: blur(14px);
      background: rgba(249, 250, 251, 0.96);
      border-bottom: 1px solid rgba(209, 213, 219, 0.9);
    }
    .nav {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0.75rem 0;
    }
    .logo-mark {
      width: 34px; height: 34px; border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, var(--accent), var(--accent-strong));
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; color: #fff;
    }
    .logo-text span:first-child {
      font-weight: 700; font-size: 0.98rem; color: var(--text-strong);
    }
    .logo-text span:last-child {
      font-size: 0.72rem; color: var(--text-subtle);
    }
    .nav-links { display: flex; gap: 1.2rem; font-size: 0.88rem; }
    .nav-links a { opacity: .9; }
    .nav-links a:hover { color: var(--accent-strong); opacity: 1; }

    .nav-right {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-size: 0.82rem;
    }

    .btn-pill {
      border-radius: var(--radius-pill);
      padding: 0.45rem 1rem;
      background: #ffffff;
      border: 1px solid rgba(209, 213, 219, 0.9);
      font-size: 0.8rem;
      cursor: pointer;
      transition: var(--transition-fast);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }
    .btn-pill:hover {
      background: #f3f4f6;
      transform: translateY(-1px);
    }

    .hero {
      padding: 2.4rem 0 1.6rem;
      text-align: center;
    }
    .hero-kicker {
      font-size: 0.78rem; letter-spacing: 0.18em; text-transform: uppercase;
      color: var(--text-subtle);
    }
    .hero-title {
      font-size: clamp(1.9rem, 3vw, 2.3rem);
      font-weight: 800; color: var(--text-strong);
      margin: 0.3rem 0;
    }
    .hero-subtitle {
      font-size: 0.96rem; color: var(--text-muted);
      max-width: 40rem; margin: 0.4rem auto 0;
    }
    .hero-breadcrumbs {
      margin-top: 0.9rem;
      font-size: 0.82rem;
      color: var(--text-subtle);
    }
    .hero-breadcrumbs a { color: var(--accent-strong); }

    main { padding-bottom: 2.5rem; }

    .steps-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      margin-top: 1rem;
    }
    .step-card {
      background: var(--bg-card);
      border-radius: var(--radius-card);
      border: 1px solid var(--border-subtle);
      padding: 1rem 1.15rem;
      box-shadow: var(--shadow-card);
      display: flex;
      flex-direction: column;
      gap: 0.55rem;
      font-size: 0.9rem;
      border-left: 4px solid rgba(126, 34, 206, 0.55);
      padding-left: 1.2rem;
    }
    .step-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
    }
    .step-header-left { display:flex;flex-direction:column;gap:0.2rem; }
    .step-index {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #4c1d95;
      background: #ede9fe;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      padding: 0.16rem 0.7rem;
      font-weight: 600;
    }
    .step-title {
      font-size: 1.06rem;
      font-weight: 650;
      color: #111827;
    }
    .step-header-right { display:flex;align-items:center;gap:0.4rem; }
    .toggle-btn {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: 1px solid rgba(129, 140, 248, 0.8);
      background: #eef2ff;
      color: #4c1d95;
      font-size: 1.2rem;
      display:flex;align-items:center;justify-content:center;
      cursor: pointer;
      padding:0;
    }
    .step-content { margin-top:0.4rem;display:block; }
    .step-body { font-size:0.86rem;color:var(--text-muted); }

    .prompt-preview {
      margin-top: 0.45rem;
      padding: 0.55rem 0.65rem;
      border-radius: 10px;
      background: #f9fafb;
      border: 1px dashed rgba(209, 213, 219, 0.9);
      font-size: 0.8rem;
      color: var(--text-subtle);
      white-space: pre-wrap;
    }
    .ai-response {
      margin-top: 0.4rem;
      padding: 0.85rem 1rem;
      border-radius: 10px;
      background: #eef2ff;
      border: 1px solid rgba(129, 140, 248, 0.5);
      font-size: 0.92rem;
      color: #111827;
      white-space: pre-wrap;
      line-height: 1.55;
    }
    .ai-response p { margin-bottom:0.75rem; }
    .ai-response ul,
    .ai-response ol { margin:0.6rem 0 0.6rem 1.2rem; }

    .copy-row {
      margin-top: 0.35rem;
      display:flex;
      justify-content:flex-end;
      gap:0.4rem;
    }

    .btn-ghost,
    .btn-primary {
      display:inline-flex;
      align-items:center;
      gap:0.25rem;
    }
    .btn-ghost {
      padding:0.42rem 0.8rem;
      border-radius:var(--radius-pill);
      font-size:0.8rem;
      border:1px solid rgba(209, 213, 219, 0.9);
      background:#ffffff;
      cursor:pointer;
    }
    .btn-primary {
      padding:0.42rem 1rem;
      border-radius:var(--radius-pill);
      font-size:0.8rem;
      font-weight:600;
      border:none;
      cursor:pointer;
      background:radial-gradient(circle at 30% 0%, #a855f7, #7e22ce, #4c1d95);
      color:#fff;
      box-shadow: 0 10px 22px rgba(79, 70, 229, 0.35);
      transition: var(--transition-fast);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
    }

    .step-footer {
      margin-top:0.6rem;
      padding-top:0.6rem;
      border-top:1px solid rgba(209, 213, 219, 0.7);
      display:flex;
      justify-content:space-between;
      gap:0.5rem;
      align-items:center;
      font-size:0.78rem;
      color:var(--text-subtle);
      flex-wrap:wrap;
    }

    footer {
      margin-top:auto;
      padding:1.8rem 0;
      text-align:center;
      font-size:0.8rem;
      color:var(--text-subtle);
    }

    @media (max-width: 860px) {
      .nav-links { display:none; }
    }
  </style>
</head>
<body>
<div class="page">

  <!-- NAV -->
  <header>
    <div class="container">
      <div class="nav">
        <div style="display:flex;align-items:center;gap:0.75rem;">
          <div class="logo-mark">P</div>
          <div class="logo-text">
            <span>PromptSchola</span>
            <span>Prompt-based Physics mastery</span>
          </div>
        </div>

        <nav class="nav-links">
          <a href="index.html">Home</a>
          <a href="physics.html">Physics</a>
          <a href="mechanics.html">Mechanics</a>
        </nav>

        <div class="nav-right">
          <!-- Filled by auth.js -->
          <span id="nav-user" style="font-size:0.78rem;color:#9ca3af;"></span>

          <!-- Shown when logged OUT -->
          <a id="nav-login-btn" href="auth.html" class="btn-pill">Sign In</a>
          <a id="nav-register-btn" href="auth.html?mode=signup" class="btn-primary">Register for Free</a>

          <!-- Shown when logged IN -->
          <button
            id="nav-signout-btn"
            type="button"
            class="btn-pill"
            style="display:none;"
          >
            Sign out
          </button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="hero">
      <div class="container">
        <div class="hero-kicker">Kinematics · 1D Motion</div>
        <h1 class="hero-title">Displacement, Speed & Velocity</h1>
        <p class="hero-subtitle">
          Learn the difference between distance and displacement, and how to compute average speed and average velocity in straight-line motion.
        </p>
        <div class="hero-breadcrumbs">
          <a href="physics.html">Physics</a> ·
          <a href="mechanics.html">Mechanics</a> ·
          <span>Displacement, Speed & Velocity</span>
        </div>
      </div>
    </section>

    <section>
      <div class="container">
        <div class="steps-grid">

          <!-- STEP 1 -->
          <article class="step-card" id="step-1-card">
            <div class="step-header">
              <div class="step-header-left">
                <div class="step-index">STEP 1</div>
                <div class="step-title">Orient: what are we trying to describe?</div>
              </div>
              <div class="step-header-right">
                <button class="toggle-btn" onclick="toggleStep(1)">−</button>
              </div>
            </div>
            <div class="step-content" id="step-content-1">
              <div class="step-body">
                Clarify the everyday idea of “how far” and “how fast” and connect it to the formal physics quantities of distance, displacement, speed, and velocity.
              </div>
              <div class="prompt-preview" id="preview-step1">
                Prompt preview will appear here when you click “Show prompt”.
              </div>
              <div class="ai-response" id="response-step1"></div>
              <div class="copy-row">
                <button class="btn-ghost" onclick="copyPrompt(1)">Copy prompt</button>
                <button class="btn-ghost" onclick="copyAnswer(1)">Copy answer</button>
                <button class="btn-primary" onclick="runWithAI(1)">Run with AI</button>
              </div>
              <div class="step-footer">
                <span>Goal: get an intuitive feel for the four key quantities.</span>
              </div>
            </div>
          </article>

          <!-- STEP 2 -->
          <article class="step-card" id="step-2-card">
            <div class="step-header">
              <div class="step-header-left">
                <div class="step-index">STEP 2</div>
                <div class="step-title">Explain: distance vs displacement</div>
              </div>
              <div class="step-header-right">
                <button class="toggle-btn" onclick="toggleStep(2)">−</button>
              </div>
            </div>
            <div class="step-content" id="step-content-2">
              <div class="step-body">
                Build a clear explanation (with a simple diagram) of how total path length (distance) differs from straight-line change in position (displacement).
              </div>
              <div class="prompt-preview" id="preview-step2">
                Prompt preview will appear here when you click “Show prompt”.
              </div>
              <div class="ai-response" id="response-step2"></div>
              <div class="copy-row">
                <button class="btn-ghost" onclick="copyPrompt(2)">Copy prompt</button>
                <button class="btn-ghost" onclick="copyAnswer(2)">Copy answer</button>
                <button class="btn-primary" onclick="runWithAI(2)">Run with AI</button>
              </div>
              <div class="step-footer">
                <span>Goal: be able to tell which problems need distance vs displacement.</span>
              </div>
            </div>
          </article>

          <!-- STEP 3 -->
          <article class="step-card" id="step-3-card">
            <div class="step-header">
              <div class="step-header-left">
                <div class="step-index">STEP 3</div>
                <div class="step-title">Explain: speed vs velocity</div>
              </div>
              <div class="step-header-right">
                <button class="toggle-btn" onclick="toggleStep(3)">−</button>
              </div>
            </div>
            <div class="step-content" id="step-content-3">
              <div class="step-body">
                Contrast average speed and average velocity, including units, sign, and how they relate to distance and displacement.
              </div>
              <div class="prompt-preview" id="preview-step3">
                Prompt preview will appear here when you click “Show prompt”.
              </div>
              <div class="ai-response" id="response-step3"></div>
              <div class="copy-row">
                <button class="btn-ghost" onclick="copyPrompt(3)">Copy prompt</button>
                <button class="btn-ghost" onclick="copyAnswer(3)">Copy answer</button>
                <button class="btn-primary" onclick="runWithAI(3)">Run with AI</button>
              </div>
              <div class="step-footer">
                <span>Goal: understand why velocity can be negative but speed cannot.</span>
              </div>
            </div>
          </article>

          <!-- STEP 4 -->
          <article class="step-card" id="step-4-card">
            <div class="step-header">
              <div class="step-header-left">
                <div class="step-index">STEP 4</div>
                <div class="step-title">Practice: numeric examples</div>
              </div>
              <div class="step-header-right">
                <button class="toggle-btn" onclick="toggleStep(4)">−</button>
              </div>
            </div>
            <div class="step-content" id="step-content-4">
              <div class="step-body">
                Work through a few problems where you compute distance, displacement, average speed, and average velocity for motion along a straight line.
              </div>
              <div class="prompt-preview" id="preview-step4">
                Prompt preview will appear here when you click “Show prompt”.
              </div>
              <div class="ai-response" id="response-step4"></div>
              <div class="copy-row">
                <button class="btn-ghost" onclick="copyPrompt(4)">Copy prompt</button>
                <button class="btn-ghost" onclick="copyAnswer(4)">Copy answer</button>
                <button class="btn-primary" onclick="runWithAI(4)">Run with AI</button>
              </div>
              <div class="step-footer">
                <span>Goal: be fluent converting word problems to numbers and formulas.</span>
              </div>
            </div>
          </article>

          <!-- STEP 5 -->
          <article class="step-card" id="step-5-card">
            <div class="step-header">
              <div class="step-header-left">
                <div class="step-index">STEP 5</div>
                <div class="step-title">Check: quick concept quiz</div>
              </div>
              <div class="step-header-right">
                <button class="toggle-btn" onclick="toggleStep(5)">−</button>
              </div>
            </div>
            <div class="step-content" id="step-content-5">
              <div class="step-body">
                Answer a short quiz mixing conceptual questions and small numerical tasks to test your understanding.
              </div>
              <div class="prompt-preview" id="preview-step5">
                Prompt preview will appear here when you click “Show prompt”.
              </div>
              <div class="ai-response" id="response-step5"></div>
              <div class="copy-row">
                <button class="btn-ghost" onclick="copyPrompt(5)">Copy prompt</button>
                <button class="btn-ghost" onclick="copyAnswer(5)">Copy answer</button>
                <button class="btn-primary" onclick="runWithAI(5)">Run with AI</button>
              </div>
              <div class="step-footer">
                <span>Goal: see if you can distinguish all four quantities in new contexts.</span>
              </div>
            </div>
          </article>

          <!-- STEP 6 -->
          <article class="step-card" id="step-6-card">
            <div class="step-header">
              <div class="step-header-left">
                <div class="step-index">STEP 6</div>
                <div class="step-title">Apply: a simple motion story</div>
              </div>
              <div class="step-header-right">
                <button class="toggle-btn" onclick="toggleStep(6)">−</button>
              </div>
            </div>
            <div class="step-content" id="step-content-6">
              <div class="step-body">
                Use a short story (e.g., walking to school and back) to compute distance, displacement, speed, and velocity, and to explain them to a friend.
              </div>
              <div class="prompt-preview" id="preview-step6">
                Prompt preview will appear here when you click “Show prompt”.
              </div>
              <div class="ai-response" id="response-step6"></div>
              <div class="copy-row">
                <button class="btn-ghost" onclick="copyPrompt(6)">Copy prompt</button>
                <button class="btn-ghost" onclick="copyAnswer(6)">Copy answer</button>
                <button class="btn-primary" onclick="runWithAI(6)">Run with AI</button>
              </div>
              <div class="step-footer">
                <span>Goal: be able to narrate motion using correct physics language.</span>
              </div>
            </div>
          </article>

        </div>
      </div>
    </section>
  </main>

  <footer>
    © 2025 PromptSchola. All rights reserved.
  </footer>
</div>

<!-- Shared Supabase + helpers -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="auth.js"></script>

<script>
  const NANO_SLUG = 'kinematics-1d-displacement-speed-velocity';

  const prompts = {
    1: `You are a physics tutor.\n\nExplain in simple language what we are trying to describe when we talk about motion in one dimension.\n\n• Start from everyday phrases like "how far did you go?" and "how fast were you going?".\n• Introduce the four key quantities: distance, displacement, speed, and velocity.\n• Give one sentence each for what they represent.\n\nUse short paragraphs and bullet points. Don’t use headings like # or ###. If you include formulas, use LaTeX display math like:\n  \\\\[ v = \\frac{\\Delta x}{\\Delta t} \\\\]\nMake sure every LaTeX expression is complete and properly enclosed in \\\\[ and \\\\].`,
    2: `You are a physics tutor.\n\nExplain the difference between **distance** and **displacement** for motion along a straight line.\n\nInclude:\n• A clear definition of distance as total path length.\n• A clear definition of displacement as change in position from start to end.\n• One simple example where distance ≠ displacement.\n\nUse bullet points and, if helpful, a small coordinate diagram in words (e.g., "start at x = 0 m, walk to x = +5 m, then back to x = +2 m").\nIf you use any symbols, write them in LaTeX display math like:\n  \\\\[ \\Delta x = x_{\\text{final}} - x_{\\text{initial}} \\\\]`,
    3: `You are a physics tutor.\n\nExplain the difference between **average speed** and **average velocity**.\n\nInclude:\n• Definitions of each.\n• Formulas in LaTeX display math, for example:\n  \\\\[ v_{\\text{avg}} = \\frac{\\Delta x}{\\Delta t} \\\\]\n  \\\\[ \\text{speed}_{\\text{avg}} = \\frac{\\text{total distance}}{\\Delta t} \\\\]\n• A short example where the magnitude of average velocity is less than the average speed.\n\nUse bullet points and short paragraphs. Do not use markdown headings.`,
    4: `You are a physics tutor.\n\nCreate 3 worked examples of motion in one dimension where the student must compute:\n• distance and displacement\n• average speed and average velocity\n\nFor each example:\n1) State the problem clearly.\n2) Show the given values.\n3) Show the formulas you use, in LaTeX display math.\n4) Compute the answer step by step.\n\nUse simple numbers and units like meters (m) and seconds (s).`,
    5: `You are a physics tutor.\n\nWrite a short concept check quiz with 5 questions mixing:\n• multiple choice\n• short answer\n\nQuestions should test if the student can:\n• distinguish distance vs displacement\n• distinguish speed vs velocity\n• choose which quantity applies in a situation.\n\nAfter listing all questions, give the answers and one-line explanations. Use bullet points, and avoid markdown headings.`,
    6: `You are a physics tutor.\n\nDescribe a short everyday motion story, for example:\n• walking from home to a store and back\n• riding a bus along a straight road\n\nAsk the student to identify:\n• the total distance traveled\n• the displacement\n• the average speed\n• the average velocity\n\nThen provide a sample solution with calculations in LaTeX display math for any formulas used.\nUse clear steps and short paragraphs.`
  };

  const lastAiResponses = {};
  const STORAGE_KEY = 'ps_nano_' + NANO_SLUG + '_collapse';
  let collapseState = {};

  async function logEvent(eventType, step) {
    try {
      let userType = 'anon';
      try {
        const user = await getCurrentUser();
        if (user) userType = 'logged';
      } catch (_) {
        // ignore, default anon
      }

      await fetch('/api/log-event', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          eventType,
          nanoSlug: NANO_SLUG,
          step,
          userType
        })
      });
    } catch (e) {
      console.error('Failed to log event:', e);
    }
  }

  function toggleStep(step) {
    const content = document.getElementById(`step-content-${step}`);
    const card = document.getElementById(`step-${step}-card`);
    const btn = card?.querySelector('.toggle-btn');
    if (!content || !btn) return;

    const isHidden = content.style.display === 'none';
    content.style.display = isHidden ? 'block' : 'none';
    btn.textContent = isHidden ? '−' : '+';

    collapseState[step] = !isHidden;
    saveCollapseState();
  }

  function loadCollapseState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      collapseState = raw ? JSON.parse(raw) : {};
    } catch (e) {
      collapseState = {};
    }
  }

  function saveCollapseState() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(collapseState));
    } catch (e) {
      console.error('Unable to save collapse state', e);
    }
  }

  function formatOutput(text) {
    if (!text) return '';
    let safe = text
      .replace(/\\\\\[/g, '\\[')
      .replace(/\\\\\]/g, '\\]');

    // Simple markdown-ish cleanup
    safe = safe.replace(/^#{1,6}\s+(.+)$/gm, '<strong>$1</strong>');
    safe = safe.replace(/^\s*[-*]\s+/gm, '• ');
    safe = safe.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    safe = safe.replace(/\*(.+?)\*/g, '<em>$1</em>');
    safe = safe.replace(/\n\n+/g, '</p><p>');
    safe = safe.replace(/\n/g, '<br>');
    safe = '<p>' + safe + '</p>';

    return safe;
  }

  async function runWithAI(step) {
    const user = await ensureLoggedInOrRedirect();
    if (!user) return;

    const prompt = prompts[step];
    if (!prompt) {
      alert('No prompt defined for this step yet.');
      return;
    }

    const output = document.getElementById('response-step' + step);
    if (!output) {
      alert('No response area found for this step.');
      return;
    }

    try {
      output.textContent = 'Running with AI…';

      logEvent('run_ai', step);

      const res = await fetch('/api/run-step', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });

      if (!res.ok) {
        output.textContent = 'There was an error contacting the AI. Please try again later.';
        return;
      }

      const data = await res.json();
      const raw = data.content || 'No response received from AI.';
      lastAiResponses[step] = raw;
      output.innerHTML = formatOutput(raw);

      if (window.MathJax && window.MathJax.typesetPromise) {
        MathJax.typesetPromise([output]).catch(err =>
          console.error('MathJax error in response:', err)
        );
      }
    } catch (err) {
      console.error(err);
      output.textContent = 'Unexpected error. Please try again.';
    }
  }

  function copyPrompt(step) {
    const text = prompts[step];
    if (!text) {
      alert('No prompt defined for this step yet.');
      return;
    }
    if (!navigator.clipboard || !navigator.clipboard.writeText) {
      alert('Clipboard not supported in this browser.');
      return;
    }
    navigator.clipboard.writeText(text)
      .then(() => {
        alert('Prompt copied to clipboard.');
        logEvent('copy_prompt', step);
      })
      .catch(err => {
        console.error(err);
        alert('Could not copy to clipboard. Please try again.');
      });
  }

  function copyAnswer(step) {
    const text = lastAiResponses[step];
    if (!text) {
      alert('No AI answer to copy yet. Run with AI first.');
      return;
    }
    if (!navigator.clipboard || !navigator.clipboard.writeText) {
      alert('Clipboard not supported in this browser.');
      return;
    }
    navigator.clipboard.writeText(text)
      .then(() => alert('Answer copied to clipboard.'))
      .catch(err => {
        console.error(err);
        alert('Could not copy to clipboard. Please try again.');
      });
  }

  document.addEventListener('DOMContentLoaded', async () => {
    // Restore collapse state
    loadCollapseState();
    const steps = [1,2,3,4,5,6];
    steps.forEach(step => {
      const content = document.getElementById(`step-content-${step}`);
      const card = document.getElementById(`step-${step}-card`);
      const btn = card?.querySelector('.toggle-btn');
      if (!content || !btn) return;

      const expanded = collapseState[step];
      if (expanded === false) {
        content.style.display = 'none';
        btn.textContent = '+';
      } else {
        content.style.display = 'block';
        btn.textContent = '−';
      }
    });

    // Initial MathJax typeset
    if (window.MathJax && window.MathJax.typesetPromise) {
      MathJax.typesetPromise().catch(err =>
        console.error('MathJax initial typeset error:', err)
      );
    }

    // Log page view
    logEvent('view_nano', null);

    // Nav user display + auth buttons
    if (typeof updateNavUserDisplay === 'function') {
      updateNavUserDisplay();
    }

    const loginBtn = document.getElementById('nav-login-btn');
    const registerBtn = document.getElementById('nav-register-btn');
    const signOutBtn = document.getElementById('nav-signout-btn');

    if (typeof getCurrentUser === 'function') {
      const user = await getCurrentUser();

      if (user) {
        // Logged IN: hide Sign In / Register, show Sign out
        if (loginBtn) loginBtn.style.display = 'none';
        if (registerBtn) registerBtn.style.display = 'none';
        if (signOutBtn) signOutBtn.style.display = 'inline-flex';
      } else {
        // Logged OUT: show Sign In / Register, hide Sign out
        if (loginBtn) loginBtn.style.display = 'inline-flex';
        if (registerBtn) registerBtn.style.display = 'inline-flex';
        if (signOutBtn) signOutBtn.style.display = 'none';
      }
    }

    if (signOutBtn && typeof signOutUser === 'function') {
      signOutBtn.addEventListener('click', signOutUser);
    }
  });
</script>
</body>
</html>
